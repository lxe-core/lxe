name: Build Bundled Runtime

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-bundled-runtime:
    name: Build Portable Runtime
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build bundler Docker image
        run: |
          docker build -t lxe-bundler -f docker/Dockerfile.bundle .
      
      - name: Build bundled runtime in container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -e BUILD_DIR=/build \
            -e OUTPUT_DIR=/build/bundled \
            lxe-bundler
      
      - name: List bundled output
        run: |
          ls -la bundled/
          ls -la bundled/libs/ || echo "No libs directory"
          echo "---"
          echo "Bundle size: $(du -sh bundled/ | cut -f1)"
      
      - name: Upload bundled runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: lxe-runtime-bundled-${{ github.sha }}
          path: bundled/
          retention-days: 7

  build-cli:
    name: Build Static CLI
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust (musl target)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
      
      - name: Install musl tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      
      - name: Build static CLI
        run: |
          cargo build --release --target x86_64-unknown-linux-musl -p lxe-cli
      
      - name: Verify static binary
        run: |
          file target/x86_64-unknown-linux-musl/release/lxe
          ldd target/x86_64-unknown-linux-musl/release/lxe || echo "Static binary (no dynamic deps)"
      
      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: lxe-cli-static-${{ github.sha }}
          path: target/x86_64-unknown-linux-musl/release/lxe
          retention-days: 7
